name: Build Naive-Caddy RPM

on:
  workflow_dispatch:          # 手动触发
  # push:
  #   tags:
  #     - 'v*.*.*'           # 可选：tag 时自动构建并 release

jobs:
  build-rpm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'   # 兼容性好；若要用最新 Caddy 可改成 '1.26'

      - name: Install dependencies
        run: |
          go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest
          sudo apt-get update
          sudo apt-get install -y rpm rpm-build

      - name: Build Caddy with Naive forwardproxy
        run: |
          ~/go/bin/xcaddy build \
            --with github.com/caddyserver/forwardproxy=github.com/klzgrad/forwardproxy@naive
          chmod +x caddy
          ./caddy version   # 打印版本确认构建成功

      - name: Prepare package files
        run: |
          mkdir -p package/{usr/bin,etc/caddy,usr/lib/systemd/system}

          cp caddy package/usr/bin/

          # 默认 Caddyfile（带 forward_proxy naive 配置）
          cat <<'EOF' > package/etc/caddy/Caddyfile
          {
              order forward_proxy before reverse_proxy
          }

          :443 {
              forward_proxy {
                  basic_auth user pass     # 请自行修改用户名密码
                  probe_resistance
              }
              file_server
          }
          EOF

          # systemd 服务文件（推荐）
          cat <<'EOF' > package/usr/lib/systemd/system/caddy-naive.service
          [Unit]
          Description=Caddy with Naive Forward Proxy
          After=network.target nss-lookup.target

          [Service]
          Type=notify
          ExecStart=/usr/bin/caddy run --environ --config /etc/caddy/Caddyfile
          ExecReload=/usr/bin/caddy reload --config /etc/caddy/Caddyfile
          TimeoutStopSec=5s
          LimitNOFILE=1048576
          LimitNPROC=512
          PrivateTmp=true
          ProtectSystem=full
          ReadWritePaths=/etc/caddy /var/lib/caddy
          AmbientCapabilities=CAP_NET_BIND_SERVICE
          User=root
          Group=root
          Restart=on-failure

          [Install]
          WantedBy=multi-user.target
          EOF

          # 打包成 tar.gz 供 rpmbuild 使用
          tar -czf caddy-naive.tar.gz -C package .

          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mv caddy-naive.tar.gz rpmbuild/SOURCES/

      - name: Create RPM spec file
        run: |
          cat <<'EOF' > rpmbuild/SPECS/caddy-naive.spec
          Name:           caddy-naive
          Version:        2.11.1                  # ← 建议更新到当前最新版（2026-02 为 v2.11.1）
          Release:        1%{?dist}
          Summary:        Caddy web server with klzgrad/forwardproxy (naive) plugin
          License:        Apache-2.0
          URL:            https://github.com/caddyserver/caddy
          Source0:        caddy-naive.tar.gz

          %description
          Custom build of Caddy with the naive forward proxy plugin from klzgrad/forwardproxy@naive.
          Includes a basic Caddyfile and systemd service unit.

          %prep
          %setup -q -n caddy-naive

          %install
          mkdir -p %{buildroot}/usr/bin
          mkdir -p %{buildroot}/etc/caddy
          mkdir -p %{buildroot}/usr/lib/systemd/system

          cp -p usr/bin/caddy %{buildroot}/usr/bin/caddy
          cp -p etc/caddy/Caddyfile %{buildroot}/etc/caddy/Caddyfile
          cp -p usr/lib/systemd/system/caddy-naive.service %{buildroot}/usr/lib/systemd/system/caddy-naive.service

          %files
          /usr/bin/caddy
          %config(noreplace) /etc/caddy/Caddyfile
          /usr/lib/systemd/system/caddy-naive.service

          %post
          # 尝试授予低端口绑定能力（容器环境可能失败，无需阻塞安装）
          setcap cap_net_bind_service=+ep /usr/bin/caddy 2>/dev/null || true

          %changelog
          * Fri Feb 27 2026 Your Name <you@example.com> - 2.11.1-1
          - Initial RPM package with Naive forwardproxy
          EOF

      - name: Build RPM
        run: |
          rpmbuild -ba \
            --define "_topdir $(pwd)/rpmbuild" \
            rpmbuild/SPECS/caddy-naive.spec
          CADDY_VER=$(./caddy version | cut -d' ' -f2 | sed 's/^v//')
          sed -i "s/Version:.*$/Version：$CADDY_VER/" rpmbuild/SPECS/caddy-naive.spec

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: caddy-naive-rpm
          path: rpmbuild/RPMS/**/caddy-naive-*.rpm
          if-no-files-found: error

      - name: Create GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: rpmbuild/RPMS/**/caddy-naive-*.rpm
          # 可选：添加 tag 名称、body 等
          # tag_name: ${{ github.ref_name }}
          # name: Caddy Naive RPM ${{ github.ref_name }}
          # body: |
          #   Auto-built Caddy with Naive forwardproxy.
